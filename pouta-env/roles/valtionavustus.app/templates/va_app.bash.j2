#!/bin/bash
set -euo pipefail

function show_usage() {
  echo "Usage: $0 --start <jar to run> <log4j config location> <default configs edn file> <specific config edn file>"
  echo "or: $0 --stop"
  exit 2
}

if [ -z ${1+x} ]; then
  show_usage
fi

pid_file=/var/tmp/va.pid

function start_app() {
  stdout_stderr_file={{ logical_volumes.logs.mount_point }}/valtionavustus/started_at_`date +'%Y%m%d%H%M%S'`_run.log
  sudo -u www ln -sf `basename $stdout_stderr_file` `dirname $stdout_stderr_file`/current_run.log
  daemon=/usr/bin/java
  daemon_args="-jar -Dlog4j.email.environment=$HOSTNAME -Dlog4j.configuration=$2 $1"

  configdefaults=$3 config=$4  start-stop-daemon --start --chuid=www  \
    --make-pidfile --pidfile $pid_file --background                      \
    --startas /bin/bash -- -c "exec $daemon $daemon_args > ${stdout_stderr_file} 2>&1"
}

function stop_app() {
  stop_timeout_seconds=30
  start-stop-daemon --stop --pidfile $pid_file --retry $stop_timeout_seconds --oknodo
}

if [ "$1" == --start ]; then
  if [ -z ${4+x} ]; then
    show_usage
  else
    start_app $2 $3 $4 $5
  fi
elif [ "$1" == --stop ]; then
  stop_app
else
  show_usage
fi