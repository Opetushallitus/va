- name: Set ssh MaxStartUps
  lineinfile: dest=/etc/ssh/sshd_config
              regexp="^MaxStartUps"
              line="MaxStartUps 50:100:200"
              state=present
  notify: Restart ssh

- name: Debug hostvars
  debug: var=hostvars

- name: Add Java repository to sources
  action: apt_repository repo='ppa:webupd8team/java'

- name: Update APT package cache
  apt: update_cache=yes cache_valid_time=3600

- name: Upgrade packages
  apt: upgrade=safe

- name: Install required packages
  apt: state=installed pkg={{ item }}
  with_items: ubuntu_common_required_packages

- name: Disallow password authentication
  lineinfile: dest=/etc/ssh/sshd_config
              regexp="^PasswordAuthentication"
              line="PasswordAuthentication no"
              state=present
  notify: Restart ssh

- name: Disallow root SSH access
  lineinfile: dest=/etc/ssh/sshd_config
              regexp="^PermitRootLogin"
              line="PermitRootLogin no"
              state=present
  notify: Restart ssh

- name: Add all our authorized keys cloud user
  authorized_key: user="{{ ansible_ssh_user }}"
                  key="{{ lookup('file', item) }}"
  with_fileglob:
    - public_keys/*

- name: Add va-gateway machine IP mapping to /etc/hosts
  lineinfile: dest=/etc/hosts regexp='.* va-gw$' line='"{{ hostvars['va-build'].ansible_all_ipv4_addresses[0] }} va-gw"' owner=root group=root mode=0644

- name: Add build machine IP mapping to /etc/hosts
  lineinfile: dest=/etc/hosts regexp='.* va-build$' line='"{{ hostvars['va-build'].ansible_all_ipv4_addresses[0] }} va-build"' owner=root group=root mode=0644

- name: Add test machine IP mapping to /etc/hosts
  lineinfile: dest=/etc/hosts regexp='.* va-test$' line='"{{ hostvars['va-test'].ansible_all_ipv4_addresses[0] }} va-test"' owner=root group=root mode=0644
