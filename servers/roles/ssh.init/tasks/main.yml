- name: Set ssh MaxStartUps
  lineinfile: dest=/etc/ssh/sshd_config
              regexp="^MaxStartUps"
              line="MaxStartUps 50:100:200"
              state=present
  notify: Restart ssh

- name: Disallow password authentication
  lineinfile: dest=/etc/ssh/sshd_config
              regexp="^PasswordAuthentication"
              line="PasswordAuthentication no"
              state=present
  notify: Restart ssh

- name: Disallow root SSH access
  lineinfile: dest=/etc/ssh/sshd_config
              regexp="^PermitRootLogin"
              line="PermitRootLogin no"
              state=present
  notify: Restart ssh

- name: Add all our authorized keys cloud user
  authorized_key: user="{{ ansible_ssh_user }}"
                  key="{{ lookup('file', item) }}"
  with_fileglob:
    - public_keys/*
  when: ansible_ssh_user == "cloud-user"

- name: Remove previous gw machine IP mappings from /etc/hosts
  lineinfile: dest=/etc/hosts regexp='^[0-9\.]* {{ item }}$' state=absent owner=root group=root mode=0644
  with_items: groups.gateways

- name: Add gateway machine IP mappings to /etc/hosts
  lineinfile: dest=/etc/hosts line='{{ hostvars[item].ansible_default_ipv4.address }} {{ item }}' owner=root group=root mode=0644
  with_items: groups.gateways

- name: Remove previous build machine IP mapping from /etc/hosts
  lineinfile: dest=/etc/hosts regexp='^[0-9\.]* {{ item }}$' state=absent owner=root group=root mode=0644
  with_items: groups.va_build

- name: Add build machine IP mapping to /etc/hosts
  lineinfile: dest=/etc/hosts line='{{ hostvars[item].ansible_default_ipv4.address }} {{ item }}' owner=root group=root mode=0644
  with_items: groups.va_build

- name: Remove previous app server IP mapping from /etc/hosts
  lineinfile: dest=/etc/hosts regexp='^[0-9\.]* {{ item }}$' state=absent owner=root group=root mode=0644
  with_items: groups.va_app

- name: Add app servers IP mapping to /etc/hosts
  lineinfile: dest=/etc/hosts line='{{ hostvars[item].ansible_default_ipv4.address }} {{ item }}' owner=root group=root mode=0644
  with_items: groups.va_app

- name: Remove previous pouta test app server IP mapping from /etc/hosts
  lineinfile: dest=/etc/hosts regexp='^[0-9\.]* {{ item }}$' state=absent owner=root group=root mode=0644
  with_items: groups.va_backend

- name: Add pouta test app servers IP mapping to /etc/hosts
  lineinfile: dest=/etc/hosts line='{{ hostvars[item].ansible_default_ipv4.address }} {{ item }}' owner=root group=root mode=0644
  with_items: groups.va_backend

- name: Remove previous pouta production app server IP mapping from /etc/hosts
  lineinfile: dest=/etc/hosts regexp='^[0-9\.]* {{ item }}$' state=absent owner=root group=root mode=0644
  with_items: groups['prod-va_backend']

- name: Add pouta production app servers IP mapping to /etc/hosts
  lineinfile: dest=/etc/hosts line='{{ hostvars[item].ansible_default_ipv4.address }} {{ item }}' owner=root group=root mode=0644
  with_items: groups['prod-va_backend']
