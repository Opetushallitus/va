- name: APT Install psycopg2
  apt: name=python-psycopg2
  when: ansible_os_family == 'Debian'

- name: YUM Install psycopg2
  yum: name=python-psycopg2
  when: ansible_os_family == 'RedHat'

- name: Create Postgresql backup directory
  file: path={{ postgresql_backup_dir }} owner=postgres group=postgres state=directory

- name: Restart PostgreSQL to get backup settings in effect (Debian)
  service: name=postgresql state=restarted
  when: ansible_os_family == 'Debian'

- name: Restart PostgreSQL to get backup settings in effect (RedHat)
  service: name=postgresql-9.4 state=restarted
  when: ansible_os_family == 'RedHat'

- name: Ensure database is created
  sudo: yes
  sudo_user: postgres
  postgresql_db: name={{dbname}}
                 encoding='UTF-8'

- name: Ensure users have access to database
  sudo: yes
  sudo_user: postgres
  postgresql_user: db={{dbname}} name={{item.dbuser}} password={{item.dbpassword}} priv=ALL
  with_items: db_accounts

- name: Ensure users do not have unnecessary privileges
  sudo: yes
  sudo_user: postgres
  postgresql_user: name={{item.dbuser}} role_attr_flags=SUPERUSER,NOCREATEDB  # Note: we might want to have NOSUPERUSER
  with_items: db_accounts
