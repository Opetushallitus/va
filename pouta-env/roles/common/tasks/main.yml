- name: Add Java repository to sources
  action: apt_repository repo='ppa:webupd8team/java'

- name: Update APT package cache
  apt: update_cache=yes cache_valid_time=3600

- name: Upgrade packages
  apt: upgrade=safe

- name: Install required packages
  apt: state=installed pkg={{ item }}
  with_items: ubuntu_common_required_packages

- name: Disallow password authentication
  lineinfile: dest=/etc/ssh/sshd_config
              regexp="^PasswordAuthentication"
              line="PasswordAuthentication no"
              state=present
  notify: Restart ssh

- name: Disallow root SSH access
  lineinfile: dest=/etc/ssh/sshd_config
              regexp="^PermitRootLogin"
              line="PermitRootLogin no"
              state=present
  notify: Restart ssh

- name: Add all our authorized keys cloud user
  authorized_key: user="{{ ansible_ssh_user }}"
                  key="{{ lookup('file', item) }}"
  with_fileglob:
    - public_keys/*

