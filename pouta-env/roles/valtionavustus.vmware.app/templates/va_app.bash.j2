#!/bin/bash
set -euo pipefail

function show_usage() {
  echo "Usage: $0 --start <application name> <jar to run> <log4j config location> <default configs edn file> <specific config edn file>"
  echo "or: $0 --stop <application name>"
  exit 2
}

if [ -z ${2+x} ]; then
  show_usage
fi

app_name=$2

pid_file=/var/tmp/${app_name}.pid

function ord() {
  LC_CTYPE=C printf '%d' "'$1"
}

function port_from_app_name() {
  app_name=$1
  number=0
  for((i=0; i<{{ '${#app_name}' }} ; i++))
    do
      ch=${app_name:i:1}
      ch_value=`ord $ch`
      number=$((number + ch_value))
    done
   echo $((number + 10000))
}

function start_app() {
  stdout_stderr_file={{ logs_dir }}/valtionavustus/${app_name}_started_at_`date +'%Y%m%d%H%M%S'`_run.log
  sudo -u www ln -sf `basename $stdout_stderr_file` `dirname $stdout_stderr_file`/${app_name}_current_run.log
  daemon=/usr/bin/java
  jmxremote_port=`port_from_app_name ${app_name}`
  jmxremote_args="-Dcom.sun.management.jmxremote\
            -Dcom.sun.management.jmxremote.port=$jmxremote_port\
            -Djava.rmi.server.hostname=127.0.0.1\
            -Dcom.sun.management.jmxremote.local.only=false\
            -Dcom.sun.management.jmxremote.authenticate=false\
            -Dcom.sun.management.jmxremote.ssl=false"
  daemon_args="-jar -Xms500m -Xmx500m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath={{ data_dir }}/www/dumps $jmxremote_args -Dlog4j.email.environment=$HOSTNAME -Dlog4j.configuration=$2 $1"

  configsecrets={{ data_dir }}/www/secret/secret-va-{{ app_profile }}.edn \
  configdefaults=$3 config=$4  start-stop-daemon --start --chuid=www  \
    --make-pidfile --pidfile $pid_file --background                      \
    --startas /bin/bash -- -c "exec $daemon $daemon_args > ${stdout_stderr_file} 2>&1"
}

function stop_app() {
  stop_timeout_seconds=30
  start-stop-daemon --stop --pidfile $pid_file --retry $stop_timeout_seconds --oknodo
}

if [ "$1" == --start ]; then
  if [ -z ${5+x} ]; then
    show_usage
  else
    start_app $3 $4 $5 $6
  fi
elif [ "$1" == --stop ]; then
  stop_app
else
  show_usage
fi