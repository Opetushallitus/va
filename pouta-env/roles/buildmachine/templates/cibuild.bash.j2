#!/bin/bash
set -euo pipefail

#echo "Cleaning workspace"
#./lein clean

#echo "Running tests"
#./lein spec -f d

echo "Building uber jar"
time ./lein uberjar

echo "Transfering to test server {{ test_machine_name }}"
SSH_KEY=~/.ssh/id_deploy
SSH_USER=va-deploy
SSH="ssh -i $SSH_KEY va-deploy@{{ test_machine_name }}"
BASE_DIR=/var/www
CURRENT_DIR=${BASE_DIR}/current
TARGET_DIR=${BASE_DIR}/va-`date +'%Y%m%d%H%M%S'`
TARGET_JAR_PATH=${TARGET_DIR}/va.jar
echo "...copying artifcats to {{ test_machine_name }}:${TARGET_DIR} ..."
$SSH "mkdir -p ${TARGET_DIR}"
scp -p -i ${SSH_KEY} target/uberjar/oph-valtionavustus-*-standalone.jar ${SSH_USER}@"{{ test_machine_name }}":${TARGET_JAR_PATH}
scp -pr -i ${SSH_KEY} config resources ${SSH_USER}@"{{ test_machine_name }}":${TARGET_DIR}
$SSH ln -sf ${TARGET_DIR} ${CURRENT_DIR}
echo "Stopping application..."
$SSH "sudo /usr/local/bin/stop_app.bash"
echo "...dropping db.."
$SSH "sudo -u postgres /usr/local/bin/run_sql.bash ${CURRENT_DIR}/resources/ddl/drop.sql"
APP_COMMAND="sudo /usr/local/bin/run_app.bash ${CURRENT_DIR}/va.jar ${CURRENT_DIR}/config/test.edn"
echo "...starting application with command \"${APP_COMMAND}\" ..."
$SSH "${APP_COMMAND}"
echo "...start done!"